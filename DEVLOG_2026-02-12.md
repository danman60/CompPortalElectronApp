# CompSync Media — Dev Log: Feb 12, 2026

## Session Summary

Built, hardened, and packaged the CompSync Media Electron app from initial prototype to field-testable installer.

---

## Timeline

### Startup & Process Cleanup
- Session started with crashed/stale Electron processes from previous session
- 13 electron processes + 25 node processes stuck in background
- Old instance was reconnecting to OBS WebSocket every 5 seconds (no password, old code)
- Killed all processes, verified log stopped growing

### Bug Fix: Duplicate OBS Connect (v1.0.1)
- **Problem:** App fired `obs:connect` twice on startup
- **Root cause:** React StrictMode double-mounts `useEffect` in dev, causing two IPC calls
- **Fix:** Added `useRef` guard in `App.tsx` — `initialized.current` prevents second execution
- **Also:** Added `window.api?.` optional chaining in `Settings.tsx` to prevent crash outside Electron context (e.g., browser-only Playwright testing)
- **Commit:** `623df18`

### Playwright Testing
- Tested main UI via `http://localhost:5173` — renders correctly
- Settings panel crashes in browser (no `window.api`) — fixed with optional chaining
- Confirmed: Playwright can test layout/rendering but NOT Electron-specific features (IPC, preload)
- Audio meters show `-inf` (no audio playing), OBS indicator green (connected)

### Robustness Audit (v1.0.2)
Full audit of all services identified 5 critical + 3 medium issues:

| # | Issue | Status |
|---|-------|--------|
| 1 | No global exception handlers | **FIXED** — `process.on('uncaughtException/unhandledRejection')` in index.ts |
| 2 | No React ErrorBoundary | **FIXED** — New `ErrorBoundary.tsx` wrapping App, shows error + "Try Again" button |
| 3 | Most IPC handlers lack try/catch | **FIXED** — New `safeHandle()` wrapper for ALL handlers in ipc.ts |
| 4 | Settings corruption = crash | **FIXED** — `getSettings()` catches bad JSON, resets to defaults |
| 5 | CSV file read errors crash app | **FIXED** — Wrapped `fs.readFileSync` + `XLSX.readFile` in try/catch, empty CSV detection |
| 6 | ffmpeg bundled twice (80MB waste) | **FIXED** — Removed ffmpeg-static from asar, kept in extraResources only |
| 7 | 100+ locale files (41MB) | **FIXED** — `electronLanguages: ["en-US"]` trims to 488KB |

**Size reduction:** 446MB → 327MB unpacked, 126MB → 98MB installer

- **Commit:** `e36bee4`

### Debug Tooling (v1.0.3)
Added 3 features for field debugging:

1. **F12 opens DevTools** — Works in both dev and production builds via `before-input-event` listener
2. **Copy Diagnostics button** — In Settings footer, copies to clipboard:
   - App version, platform, Electron/Node versions
   - OBS connection state, recording status
   - Competition info (name, routine count, source)
   - Last 150 lines of main.log
3. **Renderer error forwarding** — `console.warn/error` from UI → `[Renderer]` prefix in main.log via `console-message` event

New IPC channels: `APP_COPY_DIAGNOSTICS`, `APP_RENDERER_LOG`, `APP_TOGGLE_DEVTOOLS`

- **Commit:** `3f145cf`

### Critical Fix: Missing Dependencies (v1.0.4)
- **Problem:** Installer crashed on launch with `Cannot find module 'electron-window-state'`
- **Root cause:** `electron.vite.config.ts` uses `externalizeDepsPlugin()` which externalizes ALL `dependencies` — expects them in `node_modules/` at runtime. But `package.json` build config had `!node_modules/**/*` which excluded everything except sharp/@img.
- **Fix:** Removed the blanket `!node_modules/**/*` exclusion. Changed to only exclude `ffmpeg-static` (already in extraResources). Added `asarUnpack` for sharp/@img native modules.
- **This was the blocker** that prevented the installer from working on other machines. App worked in dev (node_modules present) but not in packaged form.
- **Commit:** `eba6c8c`

### Known Issues
- NSIS installer shows false "app is already running" warning — cosmetic, can click through
- No code signing — Windows SmartScreen may warn on first launch
- Old 1.0.1 installer locked by process, couldn't delete

---

## Commits (oldest → newest)

| Hash | Version | Description |
|------|---------|-------------|
| `5062d75` | 1.0.0 | Initial CompSync Media Electron app — full build |
| `184e7b9` | 1.0.0 | ESM interop for obs-websocket-js, installer config fixes |
| `50c20cb` | 1.0.0 | Comprehensive graceful error handling pass |
| `623df18` | 1.0.1 | Prevent duplicate OBS connect, guard Settings API calls |
| `e36bee4` | 1.0.2 | Pre-release hardening — error handling, size optimization |
| `3f145cf` | 1.0.3 | Debug/diagnostics tooling for field testing |
| `eba6c8c` | 1.0.4 | Include production dependencies in packaged app |

---

## Architecture Notes

### Build Pipeline
```
src/ → electron-vite build → out/ → electron-builder → release/
  main/        (main process)      main/index.js       CompSync Media Setup X.Y.Z.exe
  preload/     (context bridge)    preload/index.js     win-unpacked/
  renderer/    (React UI)          renderer/index.html
  shared/      (types, constants)
```

### Key Config
- `electron.vite.config.ts` — `externalizeDepsPlugin()` externalizes all deps for main/preload
- `package.json` build section — electron-builder config
- `files`: includes `out/**/*`, excludes `ffmpeg-static` from asar
- `asarUnpack`: sharp + @img (native modules need filesystem access)
- `extraResources`: ffmpeg.exe (single copy, not in asar)
- `electronLanguages`: en-US only

### Dependency Strategy
- **Bundled in JS** (renderer): react, react-dom, zustand — Vite bundles these into renderer JS
- **External in asar** (main process): electron-log, electron-store, electron-window-state, express, obs-websocket-js, papaparse, xlsx, tus-js-client, exifreader — kept in node_modules inside asar
- **Unpacked from asar**: sharp, @img — native .node binaries need filesystem access
- **In extraResources**: ffmpeg.exe — large binary, not in asar

### Logging
- File: `%APPDATA%/compsync-media/logs/main.log`
- Format: `YYYY-MM-DD HH:mm:ss.ms [level] [Scope] message`
- Max 10MB, auto-rotated
- Scopes: App, OBS, FFmpeg, Upload, Schedule, Settings, IPC, Photos
- Renderer warns/errors forwarded with `[Renderer]` prefix

### Debug Access
- **F12**: DevTools (dev + production)
- **Settings → Copy Diagnostics**: version + state + last 150 log lines → clipboard
- **Log file**: always written, even in production

---

## File Map (modified this session)

| File | Changes |
|------|---------|
| `src/main/index.ts` | Global error handlers, F12 DevTools, renderer error forwarding |
| `src/main/ipc.ts` | `safeHandle()` wrapper for all IPC, diagnostics/log/devtools channels |
| `src/main/logger.ts` | (unchanged, already solid) |
| `src/main/services/obs.ts` | Auth logging tweak |
| `src/main/services/settings.ts` | Corruption recovery (catch + reset to defaults) |
| `src/main/services/schedule.ts` | File read try/catch, empty CSV detection |
| `src/main/services/ffmpeg.ts` | Reordered path resolution (extraResources first) |
| `src/preload/index.ts` | Added toggleDevTools, copyDiagnostics, rendererLog |
| `src/renderer/App.tsx` | useRef guard for StrictMode double-mount |
| `src/renderer/main.tsx` | ErrorBoundary wrapper |
| `src/renderer/components/Settings.tsx` | window.api?.guard, Copy Diagnostics button |
| `src/renderer/components/ErrorBoundary.tsx` | NEW — crash recovery UI |
| `src/shared/types.ts` | 3 new IPC channels |
| `package.json` | Version bumps, fixed files/asarUnpack config |
| `electron.vite.config.ts` | (unchanged) |
